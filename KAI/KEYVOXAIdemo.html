<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEYVOX AI ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª UIæ¡ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Tailwind CSS Configuration for 'Inter' font */
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            },
        };

        /* Add a simple fade-in animation for chat bubbles */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Ensure smooth scrolling for chat area */
        .overflow-y-auto {
            scroll-behavior: smooth;
        }

        /* Loading indicator styling */
        .loading-dot {
            animation: bounce 1s infinite;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Modal Backdrop Styling */
        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 15; /* Below modals, above main content */
            display: none; /* Hidden by default */
        }
        
        /* QR Code Modal Styling */
        #qr-modal {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* Face ID Animation */
        @keyframes face-scan {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        .face-scan-animation {
            animation: face-scan 1.5s ease-in-out infinite;
        }
        
        /* Launch Face ID Modal Transition */
        #launch-face-id-modal {
            transition: opacity 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center p-4 min-h-screen font-inter">
    <!-- App Container - Initially hidden until Face ID is successful -->
    <div id="app-container" class="bg-white shadow-xl rounded-3xl w-full max-w-sm overflow-hidden h-[700px] hidden flex-col relative">
        <!-- Header -->
        <div class="bg-indigo-600 text-white p-4 flex items-center justify-between rounded-t-3xl z-40 flex-shrink-0">
            <button id="back-button" class="text-white text-2xl font-bold pr-4 hidden" onclick="goBack()">&#x2190;</button>
            <h1 id="header-title" class="text-xl font-semibold flex-grow text-center">KEYVOX AI</h1>
            <button id="options-button" class="text-white text-2xl pl-4" onclick="switchView('myPage')">â‹®</button>
        </div>

        <!-- Modal Backdrop for MyPage/Login/Register -->
        <div id="modal-backdrop" class="modal-backdrop"></div>

        <!-- Main Content Area - Contains Locks and Chat -->
        <div id="main-content" class="flex-grow flex flex-col overflow-hidden z-10">
            <!-- Scrollable Content Area -->
            <div id="scrollable-content" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-100">

                <!-- My Locks Section -->
                <div id="my-locks-section-wrapper" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <p class="font-semibold text-gray-700 mb-3 text-lg">ãƒã‚¤ãƒ­ãƒƒã‚¯</p>
                    <div id="my-locks-section" class="grid grid-cols-2 gap-3">
                        <!-- Lock Card 1: Front Door (Locked) -->
                        <div class="bg-indigo-100 p-3 rounded-lg flex flex-col items-center justify-center text-center shadow-sm">
                            <svg class="w-8 h-8 text-indigo-700 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <p class="text-sm font-medium text-indigo-800">ç„é–¢ãƒ‰ã‚¢</p>
                            <span class="text-xs text-indigo-600">æ–½éŒ æ¸ˆã¿</span>
                            <button class="mt-2 bg-purple-500 text-white text-xs px-3 py-1 rounded-full hover:bg-purple-600 transition duration-200" onclick="simulateQrCodeDisplay('ç„é–¢ãƒ‰ã‚¢', 'KEYVOX_DOOR_A1B2C3D4_QR')">QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º</button>
                        </div>
                        <!-- Lock Card 2: Bedroom Lock (Unlocked) -->
                        <div class="bg-green-100 p-3 rounded-lg flex flex-col items-center justify-center text-center shadow-sm">
                            <svg class="w-8 h-8 text-green-700 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                            <p class="text-sm font-medium text-green-800">å¯å®¤ã®éµ</p>
                            <span class="text-xs text-green-600">è§£éŒ æ¸ˆã¿</span>
                            <button class="mt-2 bg-purple-500 text-white text-xs px-3 py-1 rounded-full hover:bg-purple-600 transition duration-200" onclick="simulateQrCodeDisplay('å¯å®¤ã®éµ', 'KEYVOX_BEDROOM_E5F6G7H8_QR')">QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º</button>
                        </div>
                         <!-- Lock Card 3: Study (Locked) -->
                         <div class="bg-indigo-100 p-3 rounded-lg flex flex-col items-center justify-center text-center shadow-sm">
                            <svg class="w-8 h-8 text-indigo-700 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <p class="text-sm font-medium text-indigo-800">æ›¸æ–</p>
                            <span class="text-xs text-indigo-600">æ–½éŒ æ¸ˆã¿</span>
                            <button class="mt-2 bg-purple-500 text-white text-xs px-3 py-1 rounded-full hover:bg-purple-600 transition duration-200" onclick="simulateQrCodeDisplay('æ›¸æ–', 'KEYVOX_STUDY_I9J0K1L2_QR')">QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º</button>
                        </div>
                    </div>
                </div>

                <!-- Initial AI Greeting (now below locks) -->
                <div id="initial-ai-greeting" class="flex items-start space-x-2">
                    <div class="flex-shrink-0">
                        <img src="https://placehold.co/40x40/6366F1/FFFFFF?text=KAI" alt="KAI Avatar" class="rounded-full">
                    </div>
                    <div class="bg-indigo-200 text-indigo-900 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-[75%] animate-fade-in">
                        <p>ã“ã‚“ã«ã¡ã¯ã€ã‚¢ã‚­ãƒ©ã•ã‚“ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</p>
                    </div>
                </div>

                <!-- AI Quick Actions / Current State Card -->
                <div id="initial-quick-actions" class="flex justify-start">
                    <div class="flex flex-wrap gap-2 mt-2">
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full shadow-md text-sm hover:bg-indigo-600 transition duration-200" onclick="simulateQuickAction('initial_setup')">
                            ğŸš€ åˆæœŸè¨­å®šã‚’é–‹å§‹ã™ã‚‹
                        </button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full shadow-md text-sm hover:bg-indigo-600 transition duration-200" onclick="simulateQuickAction('key_issue')">
                            ğŸ”‘ åˆéµã‚’ç™ºè¡Œã™ã‚‹
                        </button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full shadow-md text-sm hover:bg-indigo-600 transition duration-200" onclick="simulateQuickAction('register_shared_key')">
                            ğŸ“¥ å—ã‘å–ã£ãŸåˆéµã‚’ç™»éŒ²
                        </button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full shadow-md text-sm hover:bg-indigo-600 transition duration-200" onclick="simulateQuickAction('settings')">
                            âš™ï¸ ãƒ­ãƒƒã‚¯è¨­å®šã‚’ç¢ºèªã™ã‚‹ âœ¨
                        </button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full shadow-md text-sm hover:bg-indigo-600 transition duration-200" onclick="simulateQuickAction('troubleshooting')">
                            â“ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° âœ¨
                        </button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full shadow-md text-sm hover:bg-indigo-600 transition duration-200" onclick="simulateQuickAction('history')">
                            ğŸ  åˆ©ç”¨å±¥æ­´ã‚’è¦‹ã‚‹
                        </button>
                    </div>
                </div>

                <!-- Mock AI Notifications (Card style) -->
                <div id="initial-notifications" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mt-4">
                    <p class="font-semibold text-gray-700 mb-2">ğŸ’¡ ãŠçŸ¥ã‚‰ã›</p>
                    <div class="flex items-center text-sm text-gray-600 mb-1">
                        <svg class="w-4 h-4 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-9a1 1 0 000 2h2a1 1 0 100-2h-2zm0 4a1 1 0 100 2h2a1 1 0 100-2h-2z" clip-rule="evenodd"></path></svg>
                        ç„é–¢ãƒ‰ã‚¢ã®é›»æ± æ®‹é‡ãŒå°‘ãªããªã£ã¦ã„ã¾ã™ã€‚
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        ãƒ‰ã‚¢ã¯å…¨ã¦æ–½éŒ ã•ã‚Œã¦ã„ã¾ã™ã€‚
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden p-4 bg-gray-100 flex items-center justify-center w-full">
                <div class="flex items-center space-x-2 bg-gray-200 p-3 rounded-full">
                    <div class="loading-dot w-2 h-2 bg-indigo-600 rounded-full"></div>
                    <div class="loading-dot w-2 h-2 bg-indigo-600 rounded-full"></div>
                    <div class="loading-dot w-2 h-2 bg-indigo-600 rounded-full"></div>
                    <span class="text-gray-700 ml-2">KAIãŒè€ƒãˆã¦ã„ã¾ã™...</span>
                </div>
            </div>
        </div>

        <!-- My Page (Always present, toggled hidden/shown by JS) -->
        <div id="my-page" class="absolute inset-0 bg-gray-50 flex flex-col hidden z-20 pt-16">
             <div class="flex-grow p-4 space-y-6 overflow-y-auto">
                <!-- Account Info Section -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <p class="font-semibold text-gray-700 mb-3 text-lg">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</p>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-600">è¡¨ç¤ºå</label>
                            <input type="text" value="ã‚¢ã‚­ãƒ©" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" value="akira@example.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed sm:text-sm" readonly>
                        </div>
                        <button class="w-full bg-indigo-500 text-white py-2 rounded-md hover:bg-indigo-600 transition duration-200">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</button>
                    </div>
                </div>

                <!-- Notification Settings Section -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <p class="font-semibold text-gray-700 mb-3 text-lg">é€šçŸ¥è¨­å®š</p>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">æ–½éŒ ãƒ»è§£éŒ é€šçŸ¥</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">é›»æ± æ®‹é‡ä½ä¸‹é€šçŸ¥</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-700">åˆéµç™ºè¡Œé€šçŸ¥</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- App Info Section -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <p class="font-semibold text-gray-700 mb-3 text-lg">ã‚¢ãƒ—ãƒªæƒ…å ±</p>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
                            <span>1.0.0</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>åˆ©ç”¨è¦ç´„</span>
                            <a href="#" class="text-indigo-600 hover:underline">ç¢ºèªã™ã‚‹</a>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</span>
                            <a href="#" class="text-indigo-600 hover:underline">ç¢ºèªã™ã‚‹</a>
                        </div>
                    </div>
                </div>

                <div class="p-4">
                    <button class="w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600 transition duration-200" onclick="switchView('login')">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>

        <!-- Login Screen (Always present, toggled hidden/shown by JS) -->
        <div id="login-screen" class="absolute inset-0 bg-gray-50 flex flex-col hidden z-30 pt-16">
             <div class="flex-grow p-6 space-y-6 flex flex-col justify-center">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="login-email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="login-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    </div>
                    <button class="w-full bg-indigo-600 text-white py-3 rounded-md font-semibold text-lg hover:bg-indigo-700 transition duration-200" onclick="simulateLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
                <a href="#" class="text-sm text-indigo-600 text-center hover:underline" onclick="alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šã®ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œã§ã™ã‹ï¼Ÿ</a>
                <div class="text-center mt-6">
                    <p class="text-gray-600">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„ã§ã™ã‹ï¼Ÿ</p>
                    <button class="text-indigo-600 font-semibold hover:underline mt-2" onclick="switchView('register')">æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</button>
                </div>
            </div>
        </div>

        <!-- Register Screen (Always present, toggled hidden/shown by JS) -->
        <div id="register-screen" class="absolute inset-0 bg-gray-50 flex flex-col hidden z-30 pt-16">
            <div class="flex-grow p-6 space-y-6 flex flex-col justify-center">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">æ–°è¦ç™»éŒ²</h2>
                <div class="space-y-4">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="register-email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="register-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    </div>
                    <div>
                        <label for="register-confirm-password" class="block text-sm font-medium text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                        <input type="password" id="register-confirm-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰">
                    </div>
                    <button class="w-full bg-indigo-600 text-white py-3 rounded-md font-semibold text-lg hover:bg-indigo-700 transition duration-200" onclick="simulateRegister()">ç™»éŒ²</button>
                </div>

                <div class="flex items-center my-6">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-500">ã¾ãŸã¯</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <div class="space-y-3">
                    <button class="w-full flex items-center justify-center bg-white border border-gray-300 py-3 rounded-md shadow-sm font-semibold text-gray-700 hover:bg-gray-50 transition duration-200" onclick="simulateGoogleLogin()">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_2013_Google.png" alt="Google Logo" class="h-5 w-5 mr-2">
                        Googleã§ç™»éŒ²
                    </button>
                    <button class="w-full flex items-center justify-center bg-white border border-gray-300 py-3 rounded-md shadow-sm font-semibold text-gray-700 hover:bg-gray-50 transition duration-200" onclick="simulateAppleLogin()">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple Logo" class="h-5 w-5 mr-2">
                        Appleã§ç™»éŒ²
                    </button>
                </div>
                
                <div class="text-center mt-6">
                    <p class="text-gray-600">ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ</p>
                    <button class="text-indigo-600 font-semibold hover:underline mt-2" onclick="switchView('login')">ãƒ­ã‚°ã‚¤ãƒ³ã¯ã“ã¡ã‚‰</button>
                </div>
            </div>
        </div>

        <!-- Chat Input Area -->
        <div id="chat-input-area" class="border-t border-gray-200 p-4 bg-white flex items-center space-x-3 rounded-b-3xl z-10 flex-shrink-0">
            <button id="home-button" class="p-3 rounded-full hover:bg-gray-200 transition-colors" onclick="returnToHomeState()">
                 <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            </button>
            <input type="text" id="chat-input" class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
            <button id="send-button" class="bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
        </div>
    </div>
    
    <!-- QR Code Modal -->
    <div id="qr-modal" class="fixed inset-0 z-40 hidden items-start justify-center pt-24" onclick="hideQrModal()">
        <div class="bg-white p-6 rounded-lg shadow-xl" onclick="event.stopPropagation()">
            <img id="qr-modal-image" src="" alt="æ‹¡å¤§ã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰" class="w-64 h-64 mx-auto">
            <p class="text-center text-gray-600 mt-4">ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</p>
        </div>
    </div>
    
    <!-- App Launch Face ID Modal -->
    <div id="launch-face-id-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100">
        <div class="text-center">
             <div class="w-32 h-32 mx-auto flex items-center justify-center">
                 <svg id="launch-face-id-scan-icon" class="w-28 h-28 text-indigo-500 face-scan-animation" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"></path></svg>
                 <svg id="launch-face-id-success-icon" class="w-28 h-28 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <p id="launch-face-id-status" class="mt-4 text-2xl font-semibold text-gray-800">Face ID</p>
        </div>
    </div>


    <script>
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        // GAS Web App URL
        // ã‚¹ãƒ†ãƒƒãƒ—1ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxzml5onddDpDyqbh4Aen6F0MC2TykWhgIpQak6mkodmrPU0WpUgcIRmSELrmCylgxM2g/exec';
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…


        // Global variable to track the current active view/screen
        let currentView = 'main'; // 'main', 'myPage', 'login', 'register'

        // Helper function to add a message to the chat area
        function addMessage(sender, textOrHtml) {
            const chatArea = document.getElementById('scrollable-content');
            const messageDiv = document.createElement('div');
            // Add a class for easy removal of dynamic messages
            messageDiv.classList.add('dynamic-message', 'flex', 'items-start', 'space-x-2');

            if (!chatArea || currentView !== 'main') {
                console.warn('Attempted to add message to a non-main chat view. Suppressing.');
                return;
            }

            if (sender === 'ai') {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0">
                        <img src="https://placehold.co/40x40/6366F1/FFFFFF?text=KAI" alt="KAI Avatar" class="rounded-full">
                    </div>
                    <div class="bg-indigo-200 text-indigo-900 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-[75%] animate-fade-in">
                        ${textOrHtml}
                    </div>
                `;
            } else { // sender === 'user'
                messageDiv.classList.remove('items-start');
                messageDiv.classList.add('justify-end');
                messageDiv.innerHTML = `
                    <div class="bg-green-200 text-green-900 p-3 rounded-tl-2xl rounded-bl-2xl rounded-br-2xl rounded-tr-2xl max-w-[75%] animate-fade-in">
                        ${textOrHtml}
                    </div>
                `;
            }
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Show loading indicator
        function showLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator && currentView === 'main') { // Only show in main chat view
                loadingIndicator.classList.remove('hidden');
                document.getElementById('scrollable-content').scrollTop = document.getElementById('scrollable-content').scrollHeight;
            }
        }

        // Hide loading indicator
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Function to call GAS backend which then calls Gemini API
        async function callGeminiViaGAS(prompt, callback = null) {
            showLoadingIndicator();

            if (GAS_WEB_APP_URL === 'ã“ã“ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸGASã®URLã‚’è²¼ã‚Šä»˜ã‘') {
                 addMessage('ai', 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆGoogle Apps Scriptï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã® `GAS_WEB_APP_URL` ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                 hideLoadingIndicator();
                 return;
            }
            
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // GASã§æ­£ã—ãå—ã‘å–ã‚‹ãŸã‚
                    },
                    body: JSON.stringify({ prompt: prompt }) // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’JSONã§é€ä¿¡
                });
                
                const result = await response.json();

                if (result.success && result.text) {
                    addMessage('ai', result.text); 
                    if (callback) {
                        callback(result.text);
                    }
                } else {
                    const errorMessage = result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    addMessage('ai', `ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€å¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
                    console.error('GAS/Gemini API Error:', result);
                }
            } catch (error) {
                addMessage('ai', 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®é€šä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                console.error('Error calling GAS backend:', error);
            } finally {
                hideLoadingIndicator();
            }
        }

        // --- View Management Functions ---
        function switchView(newView) {
            // Hide all potential full-screen views first
            const allViews = ['main-content', 'my-page', 'login-screen', 'register-screen'];
            allViews.forEach(id => document.getElementById(id).classList.add('hidden'));

            document.getElementById('chat-input-area').classList.add('hidden');
            document.getElementById('modal-backdrop').style.display = 'none';

            // Header button visibility and text
            document.getElementById('back-button').classList.add('hidden');
            document.getElementById('options-button').classList.add('hidden');
            document.getElementById('header-title').textContent = 'KEYVOX AI'; // Default title

            // Show the requested view
            if (newView === 'main') {
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('chat-input-area').classList.remove('hidden');
                document.getElementById('options-button').classList.remove('hidden'); 
            } else {
                const viewToShow = document.getElementById(newView === 'myPage' ? 'my-page' : newView + '-screen');
                viewToShow.classList.remove('hidden');
                document.getElementById('modal-backdrop').style.display = 'block';
                document.getElementById('back-button').classList.remove('hidden'); 

                if(newView === 'myPage') document.getElementById('header-title').textContent = 'ãƒã‚¤ãƒšãƒ¼ã‚¸';
                if(newView === 'login') document.getElementById('header-title').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
                if(newView === 'register') document.getElementById('header-title').textContent = 'æ–°è¦ç™»éŒ²';
            }
            
            currentView = newView; // Update global state
        }

        // Resets the chat area content to initial state, clearing dynamic messages
        function resetChatViewState() {
            const chatArea = document.getElementById('scrollable-content');
            
            document.getElementById('my-locks-section-wrapper').classList.remove('hidden');
            document.getElementById('initial-ai-greeting').classList.remove('hidden');
            document.getElementById('initial-quick-actions').classList.remove('hidden');
            document.getElementById('initial-notifications').classList.remove('hidden');

            chatArea.querySelectorAll('.dynamic-message').forEach(msg => msg.remove());

            chatArea.scrollTop = 0;

            window.currentInitialSetupStep = null;
            window.initialSetupData = {};
            window.currentKeyRegisterStep = null;
        }
        
        // Returns to home state but keeps chat history
        function returnToHomeState() {
            document.getElementById('my-locks-section-wrapper').classList.remove('hidden');
            document.getElementById('initial-ai-greeting').classList.remove('hidden');
            document.getElementById('initial-quick-actions').classList.remove('hidden');
            document.getElementById('initial-notifications').classList.remove('hidden');
            
            // Scroll to top to see the home elements
             document.getElementById('scrollable-content').scrollTop = 0;
        }


        function goBack() {
             switchView('main');
             returnToHomeState();
        }

        window.currentInitialSetupStep = null;
        window.initialSetupData = {}; 

        function startChatFlow() {
            document.getElementById('my-locks-section-wrapper').classList.add('hidden');
            document.getElementById('initial-ai-greeting').classList.add('hidden');
            document.getElementById('initial-quick-actions').classList.add('hidden');
            document.getElementById('initial-notifications').classList.add('hidden');
        }

        // Handle sending messages (user input)
        async function handleSend(userInput) {
            const chatInput = document.getElementById('chat-input');
            const finalUserInput = userInput || chatInput.value.trim();

            if (finalUserInput === '') return;
            
            startChatFlow();

            addMessage('user', finalUserInput);
            chatInput.value = '';

            if (window.currentKeyRegisterStep === 'awaiting_key_data') {
                const qrCodeData = finalUserInput; 
                window.currentKeyRegisterStep = null; 
                await registerSharedKey(qrCodeData);
                return;
            }

            const menuKeywords = ['ãƒ¡ãƒ‹ãƒ¥ãƒ¼', 'ãƒ›ãƒ¼ãƒ ', 'æœ€åˆã®ç”»é¢', 'ãƒˆãƒƒãƒ—ç”»é¢', 'æœ€åˆã«æˆ»ã‚‹', 'ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹', 'home', 'menu'];
            if (menuKeywords.some(keyword => finalUserInput.toLowerCase().includes(keyword))) {
                addMessage('ai', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                setTimeout(returnToHomeState, 500);
                return; 
            }

            if (window.currentInitialSetupStep) {
                // Initial setup flow is handled locally and does not call the AI
                handleInitialSetupFlow(finalUserInput);
                return;
            }
            
            // For all other conversations, call the AI
            await callGeminiViaGAS(finalUserInput);
        }

        function handleInitialSetupFlow(finalUserInput) {
            const currentStep = window.currentInitialSetupStep;
            window.currentInitialSetupStep = null;

            if (currentStep === 'awaiting_current_admin_pin') {
                if (finalUserInput.length === 12 && /^\d+$/.test(finalUserInput)) {
                    window.initialSetupData.currentAdminPin = finalUserInput;
                    addMessage('ai', 'ç¾åœ¨ã®ç®¡ç†è€…æš—è¨¼ç•ªå·ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚æ¬¡ã«ã€æ–°ã—ã„ç®¡ç†è€…æš—è¨¼ç•ªå·12æ¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    window.currentInitialSetupStep = 'awaiting_new_admin_pin';
                } else {
                    addMessage('ai', 'ç®¡ç†è€…æš—è¨¼ç•ªå·ã¯12æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™ã€‚');
                    window.currentInitialSetupStep = 'awaiting_current_admin_pin';
                }
            } else if (currentStep === 'awaiting_new_admin_pin') {
                if (finalUserInput.length === 12 && /^\d+$/.test(finalUserInput)) {
                    window.initialSetupData.newAdminPin = finalUserInput;
                    addMessage('ai', 'æ–°ã—ã„ç®¡ç†è€…æš—è¨¼ç•ªå·ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ç¢ºèªã®ãŸã‚ã€ã‚‚ã†ä¸€åº¦æ–°ã—ã„ç®¡ç†è€…æš—è¨¼ç•ªå·12æ¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    window.currentInitialSetupStep = 'awaiting_new_admin_pin_confirm';
                } else {
                    addMessage('ai', 'æ–°ã—ã„ç®¡ç†è€…æš—è¨¼ç•ªå·ã¯12æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™ã€‚');
                    window.currentInitialSetupStep = 'awaiting_new_admin_pin';
                }
            } else if (currentStep === 'awaiting_new_admin_pin_confirm') {
                if (finalUserInput === window.initialSetupData.newAdminPin) {
                    addMessage('ai', 'æ–°ã—ã„ç®¡ç†è€…æš—è¨¼ç•ªå·ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚ãƒ­ãƒƒã‚¯ã«è¨­å®šã™ã‚‹ãŸã‚ã®QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
                    const qrData = `ADMIN_PIN_SETUP_${window.initialSetupData.newAdminPin}`;
                    const qrUrl = `https://placehold.co/256x256/000/FFF?text=${encodeURIComponent(qrData)}`;
                    const smallQrUrl = `https://placehold.co/150x150/000/FFF?text=${encodeURIComponent(qrData)}`;
                    addMessage('ai', `
                        <img src="${smallQrUrl}" alt="ç®¡ç†è€…æš—è¨¼ç•ªå·è¨­å®šç”¨QRã‚³ãƒ¼ãƒ‰" class="w-36 h-36 mx-auto my-4 rounded-lg border border-gray-300 shadow-md cursor-pointer" onclick="showQrModal('${qrUrl}')"/>
                        <p class="text-sm mt-2">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’QR1ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                    `);
                    setTimeout(() => {
                        addMessage('ai', `
                            QRã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚­ãƒ£ãƒ³å¾Œã€ãƒ­ãƒƒã‚¯æœ¬ä½“ã®LEDã¯ã©ã®è‰²ã«ç‚¹ç¯ã—ã¾ã—ãŸã‹ï¼Ÿ
                            <div class="flex flex-col gap-2 mt-2">
                                <button class="bg-green-500 text-white px-4 py-2 rounded-full text-sm hover:bg-green-600 transition duration-200" onclick="handleLedConfirmation('green')">ğŸŸ¢ LEDãŒç·‘ã«ç‚¹ç¯ã—ãŸ</button>
                                <button class="bg-red-500 text-white px-4 py-2 rounded-full text-sm hover:bg-red-600 transition duration-200" onclick="handleLedConfirmation('red')">ğŸ”´ LEDãŒèµ¤ã«ç‚¹ç¯ã—ãŸ</button>
                            </div>
                        `);
                    }, 1500);
                } else {
                    addMessage('ai', 'å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦æ–°ã—ã„ç®¡ç†è€…æš—è¨¼ç•ªå·12æ¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    window.currentInitialSetupStep = 'awaiting_new_admin_pin';
                }
            } else if (currentStep === 'awaiting_ssid') {
                window.initialSetupData.ssid = finalUserInput;
                addMessage('ai', `SSIDã€Œ${finalUserInput}ã€ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚æ¬¡ã«ã€ãã®Wi-Fiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                window.currentInitialSetupStep = 'awaiting_password';
            } else if (currentStep === 'awaiting_password') {
                window.initialSetupData.password = finalUserInput;
                addMessage('ai', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šç”¨ã®QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
                const qrData = `WIFI_SETUP_${window.initialSetupData.ssid}_${window.initialSetupData.password}`;
                const qrUrl = `https://placehold.co/256x256/000/FFF?text=${encodeURIComponent(qrData)}`;
                const smallQrUrl = `https://placehold.co/150x150/000/FFF?text=${encodeURIComponent(qrData)}`;
                addMessage('ai', `
                    <img src="${smallQrUrl}" alt="Wi-Fiè¨­å®šç”¨QRã‚³ãƒ¼ãƒ‰" class="w-36 h-36 mx-auto my-4 rounded-lg border border-gray-300 shadow-md cursor-pointer" onclick="showQrModal('${qrUrl}')"/>
                    <p class="text-sm mt-2">ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’QR1ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                `);
                setTimeout(() => {
                    addMessage('ai', 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«ç¹‹ãŒã‚Œã°ã‚¯ãƒ©ã‚¦ãƒ‰çµŒç”±ã§æ¤œçŸ¥å¾Œï¼ç„¡äº‹ã«è¨­å®šçµ‚äº†ã—ã¾ã—ãŸï¼KEYVOX AIã‚’å¿«é©ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚');
                    window.initialSetupData = {};
                    window.currentInitialSetupStep = null;
                    setTimeout(returnToHomeState, 1500);
                }, 2000);
            }
        }

        let keyIssueFlowData = {};

        function simulateQuickAction(scenario) {
            startChatFlow();
            
            addMessage('ai', 'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ'); 

            if (scenario === 'key_issue') {
                keyIssueFlowData = {};
                setTimeout(() => { addMessage('user', 'åˆéµã‚’ç™ºè¡Œã—ãŸã„'); }, 500);
                setTimeout(() => { addMessage('ai', 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚åˆéµã‚’ç™ºè¡Œã™ã‚‹æ–¹ã®**ãŠåå‰**ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚'); }, 1000);
                setTimeout(() => { addMessage('user', 'ç”°ä¸­ã•ã‚“'); keyIssueFlowData.recipientName = 'ç”°ä¸­ã•ã‚“'; }, 1500);
                setTimeout(() => {
                    addMessage('ai', `
                        ç”°ä¸­æ§˜ã«ã€ã„ã¤ã‹ã‚‰ã„ã¤ã¾ã§ã€ã¾ãŸã¯ä½•å›ã¾ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã‹ï¼Ÿä¾‹ï¼š**ã€æ¥é€±ã®æœˆæ›œæ—¥ã‹ã‚‰æ°´æ›œæ—¥ã¾ã§ã€**ã€**ã€æœ¬æ—¥ä¸­ã€**ã€**ã€5å›ã¾ã§ã€**
                        <div class="flex flex-col gap-2 mt-2">
                            <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'æœ¬æ—¥ä¸­'); simulateKeyIssueStep('duration_selected_today');">æœ¬æ—¥ä¸­</button>
                            <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'æ—¥æ™‚ã‚’æŒ‡å®š'); simulateKeyIssueStep('duration_selected_datetime');">æ—¥æ™‚ã‚’æŒ‡å®š</button>
                            <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'å›æ•°ã‚’æŒ‡å®š'); simulateKeyIssueStep('duration_selected_count');">å›æ•°ã‚’æŒ‡å®š</button>
                        </div>
                    `);
                }, 2000);
            } else if (scenario === 'settings') {
                setTimeout(() => { handleSend('æœ€é©ãªè‡ªå‹•æ–½éŒ æ™‚é–“ã‚’ææ¡ˆã—ã¦ã»ã—ã„'); }, 500);
            } else if (scenario === 'troubleshooting') {
                setTimeout(() => { handleSend('éµãŒçªç„¶é–‹ã‹ãªããªã£ãŸã‚“ã ã‘ã©'); }, 500);
            } else if (scenario === 'history') {
                setTimeout(() => { addMessage('user', 'å…ˆé€±ã€èª°ãŒä½•æ™‚ã«ç„é–¢ã«å…¥ã£ãŸã‹çŸ¥ã‚ŠãŸã„'); }, 500);
                setTimeout(() => {
                    addMessage('ai', 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚å…ˆé€±ã®ç„é–¢ãƒ‰ã‚¢ã®åˆ©ç”¨å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã­ã€‚');
                    addMessage('ai', `
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 mt-2 text-sm text-gray-800">
                            <p class="font-semibold mb-1">åˆ©ç”¨å±¥æ­´ï¼ˆç„é–¢ãƒ‰ã‚¢ï¼šå…ˆé€±ï¼‰</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>6/10 18:30 - ã‚¢ã‚­ãƒ©ã•ã‚“ (è§£éŒ )</li>
                                <li>6/10 08:00 - ã‚¢ã‚­ãƒ©ã•ã‚“ (æ–½éŒ )</li>
                                <li>6/09 20:15 - ç”°ä¸­ã•ã‚“ (è§£éŒ  - ä¸€æ™‚éµ)</li>
                                <li>6/08 10:00 - ã‚¢ã‚­ãƒ©ã•ã‚“ (è§£éŒ )</li>
                            </ul>
                        </div>
                    `);
                    addMessage('ai', 'ç‰¹å®šã®æœŸé–“ã‚„äººç‰©ã§çµã‚Šè¾¼ã¿ã¾ã™ã‹ï¼Ÿ');
                }, 1000);
            } else if (scenario === 'initial_setup') {
                window.initialSetupData = {};
                window.currentInitialSetupStep = 'awaiting_current_admin_pin';
                setTimeout(() => { addMessage('user', 'åˆæœŸè¨­å®šã‚’é–‹å§‹ã—ãŸã„'); }, 500);
                setTimeout(() => { addMessage('ai', 'KEYVOXã‚¹ãƒãƒ¼ãƒˆãƒ­ãƒƒã‚¯ã®åˆæœŸè¨­å®šã‚’é–‹å§‹ã—ã¾ã™ã­ï¼ã¾ãšã€ç¾åœ¨ã®**ç®¡ç†è€…æš—è¨¼ç•ªå·12æ¡**ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); }, 1000);
            } else if (scenario === 'register_shared_key') {
                setTimeout(() => { addMessage('user', 'å—ã‘å–ã£ãŸåˆéµã‚’ç™»éŒ²ã—ãŸã„'); }, 500);
                setTimeout(() => { addMessage('ai', 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ç™»éŒ²ã—ãŸã„åˆéµã®æƒ…å ±ã‚’QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿å–ã‚‹ã‹ã€ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚QRã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚­ãƒ£ãƒ³ãŒå¿…è¦ãªå ´åˆã¯ã€**ã€QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã€**ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'); }, 1000);
                setTimeout(() => {
                    addMessage('ai', `
                        <div class="flex flex-col gap-2 mt-2">
                            <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³'); simulateRegisterKeyStep('scan_qr');">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
                            <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'ç›´æ¥å…¥åŠ›'); simulateRegisterKeyStep('direct_input');">ç›´æ¥å…¥åŠ›</button>
                        </div>
                    `);
                }, 1500);
            }
        }

        function simulateKeyIssueStep(step) {
            if (step === 'duration_selected_today') {
                keyIssueFlowData.validity = 'æœ¬æ—¥åˆå¾Œ3æ™‚ã‹ã‚‰å¤œ8æ™‚ã¾ã§æœ‰åŠ¹';
                setTimeout(() => { addMessage('ai', 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹**ãƒ‰ã‚¢**ã¯ã©ã¡ã‚‰ã«ã—ã¾ã™ã‹ï¼Ÿ **ã€ç„é–¢ãƒ‰ã‚¢ã®ã¿ã€**ã€ã¾ãŸã¯**ã€å…¨ã¦ã®ãƒ‰ã‚¢ã€**ãªã©ã€‚'); addMessage('ai', `
                    <div class="flex flex-col gap-2 mt-2">
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'ç„é–¢ãƒ‰ã‚¢ã®ã¿'); simulateKeyIssueStep('door_selected_and_proceed_to_type', 'ç„é–¢ãƒ‰ã‚¢');">ç„é–¢ãƒ‰ã‚¢ã®ã¿</button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'å…¨ã¦ã®ãƒ‰ã‚¢'); simulateKeyIssueStep('door_selected_and_proceed_to_type', 'å…¨ã¦ã®ãƒ‰ã‚¢');">å…¨ã¦ã®ãƒ‰ã‚¢</button>
                    </div>
                `); }, 500);
            } else if (step === 'duration_selected_datetime') {
                keyIssueFlowData.validity = 'ä»Šæ—¥ã®åˆå¾Œ3æ™‚ã‹ã‚‰å¤œ8æ™‚ã¾ã§æœ‰åŠ¹';
                setTimeout(() => { addMessage('user', 'ä»Šæ—¥ã®åˆå¾Œ3æ™‚ã‹ã‚‰å¤œ8æ™‚ã¾ã§'); }, 500);
                setTimeout(() => { addMessage('ai', 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹**ãƒ‰ã‚¢**ã¯ã©ã¡ã‚‰ã«ã—ã¾ã™ã‹ï¼Ÿ **ã€ç„é–¢ãƒ‰ã‚¢ã®ã¿ã€**ã€ã¾ãŸã¯**ã€å…¨ã¦ã®ãƒ‰ã‚¢ã€**ãªã©ã€‚'); addMessage('ai', `
                    <div class="flex flex-col gap-2 mt-2">
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'ç„é–¢ãƒ‰ã‚¢ã®ã¿'); simulateKeyIssueStep('door_selected_and_proceed_to_type', 'ç„é–¢ãƒ‰ã‚¢');">ç„é–¢ãƒ‰ã‚¢ã®ã¿</button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'å…¨ã¦ã®ãƒ‰ã‚¢'); simulateKeyIssueStep('door_selected_and_proceed_to_type', 'å…¨ã¦ã®ãƒ‰ã‚¢');">å…¨ã¦ã®ãƒ‰ã‚¢</button>
                    </div>
                `); }, 1000);
            } else if (step === 'duration_selected_count') {
                keyIssueFlowData.validity = '5å›ã¾ã§æœ‰åŠ¹';
                setTimeout(() => { addMessage('ai', 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹**ãƒ‰ã‚¢**ã¯ã©ã¡ã‚‰ã«ã—ã¾ã™ã‹ï¼Ÿ **ã€ç„é–¢ãƒ‰ã‚¢ã®ã¿ã€**ã€ã¾ãŸã¯**ã€å…¨ã¦ã®ãƒ‰ã‚¢ã€ã€**ãªã©ã€‚'); addMessage('ai', `
                    <div class="flex flex-col gap-2 mt-2">
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'ç„é–¢ãƒ‰ã‚¢ã®ã¿'); simulateKeyIssueStep('door_selected_and_proceed_to_type', 'ç„é–¢ãƒ‰ã‚¢');">ç„é–¢ãƒ‰ã‚¢ã®ã¿</button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'å…¨ã¦ã®ãƒ‰ã‚¢'); simulateKeyIssueStep('door_selected_and_proceed_to_type', 'å…¨ã¦ã®ãƒ‰ã‚¢');">å…¨ã¦ã®ãƒ‰ã‚¢</button>
                    </div>
                `); }, 500);
            } else if (step === 'door_selected_and_proceed_to_type') {
                keyIssueFlowData.lockName = arguments[1];
                setTimeout(() => { addMessage('user', keyIssueFlowData.lockName); }, 500);
                setTimeout(() => { addMessage('ai', 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ç™ºè¡Œã™ã‚‹éµã®ç¨®é¡ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚**QRã‚³ãƒ¼ãƒ‰**ã€**æš—è¨¼ç•ªå·**ã€ã¾ãŸã¯**ã‚¢ãƒ—ãƒª**ã‹ã‚‰é¸æŠã„ãŸã ã‘ã¾ã™ã€‚'); addMessage('ai', `
                    <div class="flex flex-col gap-2 mt-2">
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'QRã‚³ãƒ¼ãƒ‰'); simulateKeyIssueStep('key_type_selected', 'QRã‚³ãƒ¼ãƒ‰');">QRã‚³ãƒ¼ãƒ‰</button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'æš—è¨¼ç•ªå·'); simulateKeyIssueStep('key_type_selected', 'æš—è¨¼ç•ªå·');">æš—è¨¼ç•ªå·</button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('user', 'ã‚¢ãƒ—ãƒª'); simulateKeyIssueStep('key_type_selected', 'ã‚¢ãƒ—ãƒª');">ã‚¢ãƒ—ãƒª</button>
                    </div>
                `); }, 1000);
            } else if (step === 'key_type_selected') {
                keyIssueFlowData.keyType = arguments[1];
                setTimeout(() => { simulateKeyIssueStep('confirm_issue'); }, 500);
            } else if (step === 'confirm_issue') {
                let confirmationText;
                let qrCodeContentForShare = '';
                if (keyIssueFlowData.keyType === 'QRã‚³ãƒ¼ãƒ‰') {
                    confirmationText = `${keyIssueFlowData.recipientName}æ§˜ã«ã€${keyIssueFlowData.validity}æœ‰åŠ¹ãª${keyIssueFlowData.lockName}ã®**QRã‚³ãƒ¼ãƒ‰éµ**ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ`;
                    qrCodeContentForShare = `KEYVOX_QR_${keyIssueFlowData.lockName}_${Math.random().toString(36).substring(2, 9)}`;
                } else if (keyIssueFlowData.keyType === 'æš—è¨¼ç•ªå·') {
                    const pin = Math.floor(1000 + Math.random() * 9000);
                    confirmationText = `${keyIssueFlowData.recipientName}æ§˜ã«ã€${keyIssueFlowData.validity}æœ‰åŠ¹ãª${keyIssueFlowData.lockName}ã®**æš—è¨¼ç•ªå·éµ**ï¼ˆãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰: ${pin}ï¼‰ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ`;
                    qrCodeContentForShare = `KEYVOX_PIN_${keyIssueFlowData.lockName}_${pin}`;
                } else if (keyIssueFlowData.keyType === 'ã‚¢ãƒ—ãƒª') {
                    confirmationText = `${keyIssueFlowData.recipientName}æ§˜ã«ã€${keyIssueFlowData.validity}æœ‰åŠ¹ãª${keyIssueFlowData.lockName}ã®**ã‚¢ãƒ—ãƒªéµ**ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ`;
                    qrCodeContentForShare = `https://example.com/keyvox/appkey/register?token=${Math.random().toString(36).substring(2, 15)}`;
                }

                addMessage('ai', confirmationText);
                addMessage('ai', `
                    <div class="flex flex-wrap gap-2 mt-2">
                        <button class="bg-green-500 text-white px-4 py-2 rounded-full text-sm hover:bg-green-600 transition duration-200" onclick="addMessage('user', 'ã¯ã„'); simulateKeyIssueStep('final_sharing_options', '${qrCodeContentForShare}');">ã¯ã„</button>
                        <button class="bg-red-500 text-white px-4 py-2 rounded-full text-sm hover:bg-red-600 transition duration-200" onclick="addMessage('user', 'ã„ã„ãˆ');">ã„ã„ãˆ</button>
                    </div>
                `);
            } else if (step === 'final_sharing_options') {
                const qrCodeContentForShare = arguments[1];
                keyIssueFlowData.generatedKeyData = qrCodeContentForShare;
                setTimeout(() => { addMessage('ai', 'åˆéµç™ºè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚å…±æœ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); addMessage('ai', `
                    <div class="flex flex-col gap-2 mt-2">
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="shareKeyvoxKey('${keyIssueFlowData.recipientName}', '${keyIssueFlowData.lockName}', '${qrCodeContentForShare}', '${keyIssueFlowData.keyType}');">å…±æœ‰ã™ã‚‹ (OSå…±æœ‰æ©Ÿèƒ½)</button>
                        <button class="bg-indigo-500 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-600 transition duration-200" onclick="addMessage('ai', '${keyIssueFlowData.recipientName}æ§˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯SMSã«é€ä»˜ã—ã¾ã™ã€‚é€£çµ¡å…ˆã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ');">é€£çµ¡å…ˆã«é€ä»˜ã™ã‚‹ (ã‚¢ãƒ—ãƒªå†…æ©Ÿèƒ½)</button>
                    </div>
                `); }, 500);
            }
        }
        
        function simulateQrCodeDisplay(lockName, qrCodeData) {
            const largeQrUrl = `https://placehold.co/256x256/000/FFF?text=${encodeURIComponent('KEYVOX\\n' + qrCodeData)}`;
            showQrModal(largeQrUrl);
        }

        async function shareKeyvoxKey(recipientName, lockName, keyContent, keyType) {
            if (navigator.share) {
                try {
                    let shareTitle = `KEYVOX ${lockName}ã®${keyType}éµ`;
                    let shareText = `${recipientName}æ§˜ã¸ã€KEYVOXã‚¹ãƒãƒ¼ãƒˆãƒ­ãƒƒã‚¯ã€Œ${lockName}ã€ã®${keyType}éµã§ã™ã€‚`;
                    let shareUrl = '';

                    if (keyType === 'QRã‚³ãƒ¼ãƒ‰' || keyType === 'ã‚¢ãƒ—ãƒª') {
                        shareUrl = `https://example.com/keyvox/share?data=${encodeURIComponent(keyContent)}`;
                        shareText += `\nä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„: ${shareUrl}`;
                    } else if (keyType === 'æš—è¨¼ç•ªå·') {
                        shareText += `\nãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰: ${keyContent}\nã”æ¡ˆå†…ã‚’ã”ç¢ºèªãã ã•ã„: https://example.com/keyvox/pin_guide`;
                        shareUrl = `https://example.com/keyvox/pin_share?code=${encodeURIComponent(keyContent)}`;
                    }

                    await navigator.share({
                        title: shareTitle,
                        text: shareText,
                        url: shareUrl
                    });
                    addMessage('ai', `åˆéµã®å…±æœ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚`);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        addMessage('ai', 'åˆéµã®å…±æœ‰ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚');
                    } else {
                        addMessage('ai', `å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                        console.error('Sharing failed:', error);
                    }
                }
            } else {
                addMessage('ai', 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å…±æœ‰æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒªãƒ³ã‚¯ã‚„æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ‰‹å‹•ã§å…±æœ‰ã—ã¦ãã ã•ã„: ' + keyContent);
            }
        }

        let registrationFlowData = {};

        function simulateRegisterKeyStep(step) {
            if (step === 'scan_qr') {
                addMessage('ai', 'QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã‚’QRã‚³ãƒ¼ãƒ‰ã«ã‹ã–ã—ã¦ãã ã•ã„ã€‚');
                setTimeout(() => {
                    addMessage('ai', 'ï¼ˆãƒ‡ãƒ¢ã®ãŸã‚ã€ä»£ã‚ã‚Šã«QRã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿æ–‡å­—åˆ—ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼‰');
                    window.currentKeyRegisterStep = 'awaiting_key_data';
                }, 1500);
            } else if (step === 'direct_input') {
                addMessage('ai', 'åˆéµã®ãƒ‡ãƒ¼ã‚¿æ–‡å­—åˆ—ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹: KEYVOX_TANAKA_TEMPORARY_QR ã¾ãŸã¯ https://example.com/keyvox/appkey/register?token=...ï¼‰');
                window.currentKeyRegisterStep = 'awaiting_key_data';
            }
        }

        async function registerSharedKey(qrCodeData) {
            const keyInfo = parseQrCodeData(qrCodeData);

            if (!keyInfo) {
                addMessage('ai', 'å…¥åŠ›ã•ã‚ŒãŸåˆéµã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }

            registrationFlowData = keyInfo;

            const prompt = `ã‚ãªãŸã¯KEYVOX AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ã€ŒKAIï¼ˆã‚«ã‚¤ï¼‰ã€ã§ã™ã€‚ä»¥ä¸‹ã®åˆéµæƒ…å ±ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã€ã‚¢ãƒ—ãƒªã«ç™»éŒ²ã™ã‚‹ã‹ã©ã†ã‹ã‚’å°‹ã­ã¦ãã ã•ã„ã€‚
            åˆéµæƒ…å ±: ${JSON.stringify(keyInfo)}

            ä¾‹: ãã®åˆéµã¯ã€ã€‡ã€‡æ§˜ãŒã€‡ã€‡ãƒ‰ã‚¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ç™ºè¡Œã•ã‚ŒãŸä¸€æ™‚çš„ãªéµï¼ˆã€‡æœˆã€‡æ—¥ã‹ã‚‰ã€‡æœˆã€‡æ—¥ã¾ã§æœ‰åŠ¹ï¼‰ã®ã‚ˆã†ã§ã™ã­ã€‚ã“ã®éµã‚’ã‚ãªãŸã®KEYVOX AIã‚¢ãƒ—ãƒªã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`;

            await callGeminiViaGAS(prompt, (llmResponse) => {
                setTimeout(() => {
                    addMessage('ai', `
                        <div class="flex flex-wrap gap-2 mt-2">
                            <button class="bg-green-500 text-white px-4 py-2 rounded-full text-sm hover:bg-green-600 transition duration-200" onclick="confirmRegisterSharedKey(true);">ã¯ã„ã€ç™»éŒ²ã—ã¾ã™</button>
                            <button class="bg-red-500 text-white px-4 py-2 rounded-full text-sm hover:bg-red-600 transition duration-200" onclick="confirmRegisterSharedKey(false);">ã„ã„ãˆã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™</button>
                        </div>
                    `);
                }, 500);
            });
        }

        let newLockCounter = 0;

        function parseQrCodeData(data) {
            if (data.startsWith('https://example.com/keyvox/appkey/register?token=')) {
                return {
                    id: `new_app_lock_${++newLockCounter}`,
                    issuer: 'ã‚¢ã‚­ãƒ©æ§˜',
                    lockName: 'å…±æœ‰ã•ã‚ŒãŸã‚¢ãƒ—ãƒªéµ',
                    type: 'ã‚¢ãƒ—ãƒª',
                    validity: 'æä¾›è€…ã«ã‚ˆã‚‹'
                };
            } else if (data === 'KEYVOX_TANAKA_TEMPORARY_QR') {
                return {
                    id: `temp_qr_lock_${++newLockCounter}`,
                    issuer: 'ç”°ä¸­æ§˜',
                    lockName: 'ç„é–¢ãƒ‰ã‚¢',
                    type: 'QRã‚³ãƒ¼ãƒ‰',
                    validity: 'æœ¬æ—¥åˆå¾Œ3æ™‚ã‹ã‚‰å¤œ8æ™‚ã¾ã§æœ‰åŠ¹'
                };
            } else if (data === 'KEYVOX_MANAGER_FULLACCESS_QR') {
                return {
                    id: `full_access_qr_lock_${++newLockCounter}`,
                    issuer: 'ã‚¢ã‚­ãƒ©æ§˜',
                    lockName: 'æ›¸æ–',
                    type: 'QRã‚³ãƒ¼ãƒ‰',
                    validity: 'å¸¸ã«æœ‰åŠ¹'
                };
            }
            return null;
        }

        function confirmRegisterSharedKey(isConfirmed) {
            if (isConfirmed) {
                addMessage('user', 'ã¯ã„ã€ç™»éŒ²ã—ã¾ã™');
                setTimeout(() => {
                    addNewLockCardToUI(
                        registrationFlowData.id,
                        registrationFlowData.lockName,
                        'æ–½éŒ æ¸ˆã¿'
                    );
                    addMessage('ai', `åˆéµã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ–°ã—ã„éµã€Œ${registrationFlowData.lockName}ã€ãŒãƒã‚¤ãƒ­ãƒƒã‚¯ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚`);
                    registrationFlowData = {};
                }, 500);
            } else {
                addMessage('user', 'ã„ã„ãˆã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™');
                setTimeout(() => {
                    addMessage('ai', 'åˆéµã®ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚ä½•ã‹ä»–ã«ç”¨ä»¶ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ');
                    registrationFlowData = {};
                }, 500);
            }
        }

        function addNewLockCardToUI(lockId, lockName, status) {
            const myLocksSectionGrid = document.getElementById('my-locks-section');
            document.getElementById('my-locks-section-wrapper').classList.remove('hidden');

            const isLocked = status === 'æ–½éŒ æ¸ˆã¿';
            const bgColor = isLocked ? 'bg-indigo-100' : 'bg-green-100';
            const textColor = isLocked ? 'text-indigo-800' : 'text-green-800';
            const iconColor = isLocked ? 'text-indigo-700' : 'text-green-700';
            const statusColor = isLocked ? 'text-indigo-600' : 'text-green-600';
            const lockIconPath = isLocked ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>';

            const newLockCardHtml = `
                <div id="${lockId}" class="${bgColor} p-3 rounded-lg flex flex-col items-center justify-center text-center shadow-sm">
                    <svg class="w-8 h-8 ${iconColor} mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${lockIconPath}</svg>
                    <p class="text-sm font-medium ${textColor}">${lockName}</p>
                    <span class="text-xs ${statusColor}">${status}</span>
                    <button class="mt-2 bg-purple-500 text-white text-xs px-3 py-1 rounded-full hover:bg-purple-600 transition duration-200" onclick="simulateQrCodeDisplay('${lockName}', '${lockId}_QR')">QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º</button>
                </div>
            `;
            myLocksSectionGrid.insertAdjacentHTML('beforeend', newLockCardHtml);
        }
        
        // --- Modal Functions (QR) ---
        function showQrModal(qrUrl) {
            const qrModal = document.getElementById('qr-modal');
            const qrModalImage = document.getElementById('qr-modal-image');
            qrModalImage.src = qrUrl;
            qrModal.classList.remove('hidden');
            qrModal.classList.add('flex');
        }

        function hideQrModal() {
            const modal = document.getElementById('qr-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        // --- Initial Setup LED Confirmation ---
        function handleLedConfirmation(status) {
            if (status === 'green') {
                addMessage('user', 'LEDãŒç·‘ã«ç‚¹ç¯ã—ãŸ');
                setTimeout(() => {
                    addMessage('ai', 'ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’é–‹å§‹ã—ã¾ã™ã€‚æ¥ç¶šã—ãŸã„2.4Ghzã®SSIDã‚’æ•™ãˆã¦ãã ã•ã„ã€‚');
                    window.currentInitialSetupStep = 'awaiting_ssid';
                }, 500);
            } else if (status === 'red') {
                addMessage('user', 'LEDãŒèµ¤ã«ç‚¹ç¯ã—ãŸ');
                setTimeout(() => {
                    addMessage('ai', 'è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ã®ã‚¹ã‚­ãƒ£ãƒ³ã«å•é¡ŒãŒã‚ã£ãŸã‹ã€å…¥åŠ›ã•ã‚ŒãŸæƒ…å ±ã«èª¤ã‚ŠãŒã‚ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ã€æ–°ã—ã„ç®¡ç†è€…æš—è¨¼ç•ªå·ã‚’12æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    window.currentInitialSetupStep = 'awaiting_new_admin_pin';
                }, 500);
            }
        }

        // --- App Launch Simulation ---
        function simulateAppLaunch() {
            const appContainer = document.getElementById('app-container');
            const launchModal = document.getElementById('launch-face-id-modal');
            const scanIcon = document.getElementById('launch-face-id-scan-icon');
            const successIcon = document.getElementById('launch-face-id-success-icon');
            const statusText = document.getElementById('launch-face-id-status');
            
            // 1. Simulate scan
            setTimeout(() => {
                // 2. Show success state
                scanIcon.classList.add('hidden');
                successIcon.classList.remove('hidden');
                statusText.textContent = 'èªè¨¼æˆåŠŸ';
                
                // 3. Hide modal and show app
                setTimeout(() => {
                    launchModal.style.opacity = '0';
                    launchModal.addEventListener('transitionend', () => {
                       launchModal.classList.add('hidden'); 
                    });
                    
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('flex');
                    switchView('main');
                }, 500); 
                
            }, 2000); 
        }

        // Event listener for send button click
        document.getElementById('send-button').addEventListener('click', () => handleSend());

        // Event listener for Enter key in input field
        document.getElementById('chat-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                handleSend();
            }
        });

        // Event listener for options button (to toggle My Page)
        document.getElementById('options-button').addEventListener('click', () => switchView('myPage'));

        // Event listener for the global back button in the header
        document.getElementById('back-button').addEventListener('click', goBack);


        // Initial setup for the app when loaded
        window.onload = function() {
            simulateAppLaunch();
        };
    </script>
</body>
</html>
